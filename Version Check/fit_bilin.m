function out = fit_bilin(x,y,z)


out = zeros(length(x)-1, length(y)-1, 4);

for i = 1:(length(x)-1)
for j = 1:(length(y)-1)

    q11=z(i,j);
    q21=z(i+1,j);
    q12=z(i,j+1);
    q22=z(i+1,j+1);

    x1=x(i);
    x2=x(i+1);

    y1=y(j);
    y2=y(j+1);

    A=[1 x1 y1 x1*y1;
       1 x1 y2 x1*y2;
       1 x2 y1 x2*y1;
       1 x2 y2 x2*y2];

    b = [q11; q12; q21; q22];
    
  
    sigma = 1/(A(1, 1)*A(2, 2)*A(3, 3)*A(4, 4) - A(1, 1)*A(2, 2)*A(3, 4)*A(4, 3) - A(1, 1)*A(2, 3)*A(3, 2)*A(4, 4) + A(1, 1)*A(2, 3)*A(4, 2)*A(3, 4) + A(1, 1)*A(3, 2)*A(2, 4)*A(4, 3) - A(1, 1)*A(2, 4)*A(3, 3)*A(4, 2) - A(1, 2)*A(2, 1)*A(3, 3)*A(4, 4) + A(1, 2)*A(2, 1)*A(3, 4)*A(4, 3) + A(1, 2)*A(3, 1)*A(2, 3)*A(4, 4) - A(1, 2)*A(3, 1)*A(2, 4)*A(4, 3) - A(1, 2)*A(2, 3)*A(4, 1)*A(3, 4) + A(1, 2)*A(4, 1)*A(2, 4)*A(3, 3) + A(2, 1)*A(1, 3)*A(3, 2)*A(4, 4) - A(2, 1)*A(1, 3)*A(4, 2)*A(3, 4) - A(2, 1)*A(1, 4)*A(3, 2)*A(4, 3) + A(2, 1)*A(1, 4)*A(3, 3)*A(4, 2) - A(1, 3)*A(2, 2)*A(3, 1)*A(4, 4) + A(1, 3)*A(2, 2)*A(4, 1)*A(3, 4) + A(1, 3)*A(3, 1)*A(2, 4)*A(4, 2) - A(1, 3)*A(3, 2)*A(4, 1)*A(2, 4) + A(2, 2)*A(3, 1)*A(1, 4)*A(4, 3) - A(2, 2)*A(1, 4)*A(4, 1)*A(3, 3) - A(3, 1)*A(1, 4)*A(2, 3)*A(4, 2) + A(1, 4)*A(2, 3)*A(3, 2)*A(4, 1));   
     Ainv =[  sigma*(A(2, 2)*A(3, 3)*A(4, 4) - A(2, 2)*A(3, 4)*A(4, 3) - A(2, 3)*A(3, 2)*A(4, 4) + A(2, 3)*A(4, 2)*A(3, 4) + A(3, 2)*A(2, 4)*A(4, 3) - A(2, 4)*A(3, 3)*A(4, 2)), -sigma*(A(1, 2)*A(3, 3)*A(4, 4) - A(1, 2)*A(3, 4)*A(4, 3) - A(1, 3)*A(3, 2)*A(4, 4) + A(1, 3)*A(4, 2)*A(3, 4) + A(1, 4)*A(3, 2)*A(4, 3) - A(1, 4)*A(3, 3)*A(4, 2)),  sigma*(A(1, 2)*A(2, 3)*A(4, 4) - A(1, 2)*A(2, 4)*A(4, 3) - A(1, 3)*A(2, 2)*A(4, 4) + A(1, 3)*A(2, 4)*A(4, 2) + A(2, 2)*A(1, 4)*A(4, 3) - A(1, 4)*A(2, 3)*A(4, 2)), -sigma*(A(1, 2)*A(2, 3)*A(3, 4) - A(1, 2)*A(2, 4)*A(3, 3) - A(1, 3)*A(2, 2)*A(3, 4) + A(1, 3)*A(3, 2)*A(2, 4) + A(2, 2)*A(1, 4)*A(3, 3) - A(1, 4)*A(2, 3)*A(3, 2));
             -sigma*(A(2, 1)*A(3, 3)*A(4, 4) - A(2, 1)*A(3, 4)*A(4, 3) - A(3, 1)*A(2, 3)*A(4, 4) + A(3, 1)*A(2, 4)*A(4, 3) + A(2, 3)*A(4, 1)*A(3, 4) - A(4, 1)*A(2, 4)*A(3, 3)),  sigma*(A(1, 1)*A(3, 3)*A(4, 4) - A(1, 1)*A(3, 4)*A(4, 3) - A(1, 3)*A(3, 1)*A(4, 4) + A(1, 3)*A(4, 1)*A(3, 4) + A(3, 1)*A(1, 4)*A(4, 3) - A(1, 4)*A(4, 1)*A(3, 3)), -sigma*(A(1, 1)*A(2, 3)*A(4, 4) - A(1, 1)*A(2, 4)*A(4, 3) - A(2, 1)*A(1, 3)*A(4, 4) + A(2, 1)*A(1, 4)*A(4, 3) + A(1, 3)*A(4, 1)*A(2, 4) - A(1, 4)*A(2, 3)*A(4, 1)),  sigma*(A(1, 1)*A(2, 3)*A(3, 4) - A(1, 1)*A(2, 4)*A(3, 3) - A(2, 1)*A(1, 3)*A(3, 4) + A(2, 1)*A(1, 4)*A(3, 3) + A(1, 3)*A(3, 1)*A(2, 4) - A(3, 1)*A(1, 4)*A(2, 3));
              sigma*(A(2, 1)*A(3, 2)*A(4, 4) - A(2, 1)*A(4, 2)*A(3, 4) - A(2, 2)*A(3, 1)*A(4, 4) + A(2, 2)*A(4, 1)*A(3, 4) + A(3, 1)*A(2, 4)*A(4, 2) - A(3, 2)*A(4, 1)*A(2, 4)), -sigma*(A(1, 1)*A(3, 2)*A(4, 4) - A(1, 1)*A(4, 2)*A(3, 4) - A(1, 2)*A(3, 1)*A(4, 4) + A(1, 2)*A(4, 1)*A(3, 4) + A(3, 1)*A(1, 4)*A(4, 2) - A(1, 4)*A(3, 2)*A(4, 1)),  sigma*(A(1, 1)*A(2, 2)*A(4, 4) - A(1, 1)*A(2, 4)*A(4, 2) - A(1, 2)*A(2, 1)*A(4, 4) + A(1, 2)*A(4, 1)*A(2, 4) + A(2, 1)*A(1, 4)*A(4, 2) - A(2, 2)*A(1, 4)*A(4, 1)), -sigma*(A(1, 1)*A(2, 2)*A(3, 4) - A(1, 1)*A(3, 2)*A(2, 4) - A(1, 2)*A(2, 1)*A(3, 4) + A(1, 2)*A(3, 1)*A(2, 4) + A(2, 1)*A(1, 4)*A(3, 2) - A(2, 2)*A(3, 1)*A(1, 4));
             -sigma*(A(2, 1)*A(3, 2)*A(4, 3) - A(2, 1)*A(3, 3)*A(4, 2) - A(2, 2)*A(3, 1)*A(4, 3) + A(2, 2)*A(4, 1)*A(3, 3) + A(3, 1)*A(2, 3)*A(4, 2) - A(2, 3)*A(3, 2)*A(4, 1)),  sigma*(A(1, 1)*A(3, 2)*A(4, 3) - A(1, 1)*A(3, 3)*A(4, 2) - A(1, 2)*A(3, 1)*A(4, 3) + A(1, 2)*A(4, 1)*A(3, 3) + A(1, 3)*A(3, 1)*A(4, 2) - A(1, 3)*A(3, 2)*A(4, 1)), -sigma*(A(1, 1)*A(2, 2)*A(4, 3) - A(1, 1)*A(2, 3)*A(4, 2) - A(1, 2)*A(2, 1)*A(4, 3) + A(1, 2)*A(2, 3)*A(4, 1) + A(2, 1)*A(1, 3)*A(4, 2) - A(1, 3)*A(2, 2)*A(4, 1)),  sigma*(A(1, 1)*A(2, 2)*A(3, 3) - A(1, 1)*A(2, 3)*A(3, 2) - A(1, 2)*A(2, 1)*A(3, 3) + A(1, 2)*A(3, 1)*A(2, 3) + A(2, 1)*A(1, 3)*A(3, 2) - A(1, 3)*A(2, 2)*A(3, 1))];
%  

    
   % coeff = A\b;
    coeff = Ainv * b;
  
    out(i,j,:) = coeff;

end
end